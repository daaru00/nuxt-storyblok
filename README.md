# Nuxt Storyblok Integration

This is a Nuxt project that integrate [Storyblok CMS](https://www.storyblok.com/).

## Configurations

Create a `.env` file in the root of the project:
```
STORYBLOK_API_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxx
STORYBLOK_BRIDGE_ENABLED=yes
STORYBLOK_FRONTEND_FETCH_ENABLED=yes
STORYBLOK_VERSION=draft
```

Here a detailed list of environment variables:
**STORYBLOK_API_TOKEN**: The Storyblok API token (required).

**STORYBLOK_BRIDGE_ENABLED**: Enable the Storyblok Bridge integration, set to `yes` if you want to use the Storyblok editor preview with this environment.

**STORYBLOK_FRONTEND_FETCH_ENABLED**: Set this variable to `yes` to load Storyblok page data on the frontend during page load.

**STORYBLOK_VERSION**: The Storyblok data version to retrieve, possible values are `published` or `draft`.

## Recommended configurations

Localhost (Dev):
```
STORYBLOK_API_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxx
STORYBLOK_BRIDGE_ENABLED=yes
STORYBLOK_FRONTEND_FETCH_ENABLED=yes
STORYBLOK_VERSION=draft
```

Staging (SPA):
```
STORYBLOK_API_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxx
STORYBLOK_BRIDGE_ENABLED=yes
STORYBLOK_FRONTEND_FETCH_ENABLED=yes
STORYBLOK_VERSION=draft
```

Production (Static):
```
STORYBLOK_API_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxx
STORYBLOK_BRIDGE_ENABLED=no
STORYBLOK_FRONTEND_FETCH_ENABLED=no
STORYBLOK_VERSION=published
```

## Build Setup

Install dependencies:
```bash
$ npm install
```

Serve with hot reload at `localhost:3000`:
```bash
$ npm run dev
```

Build for production and launch server:
```bash
$ npm run build
$ npm run start
```

Generate static project:
```bash
$ npm run generate
```

For detailed explanation on how things work, check out [Nuxt.js docs](https://nuxtjs.org).

## AWS Infrastructure

This project describe two different approach to host a Nuxt static/spa web application:

### Single Page Application (SPA)

In `template.spa.yml` are describes:
- an S3 bucket, where the code generated by Nuxt `generate` command will be deployed.
- a CloudFront distribution to handle on-the-edge caching.

The S3 bucket is configured to use the `index.html` both for index and for error pages. With this configuration the not found error from S3 Bucket are ignored and it will return anyway the `index.html`.

Also the CloudFront distribution is configured to ignore error status code from S3 Bucket and return `index.html` with 200 status code.

### Static

In `template.static.yml` are describes:
- an S3 bucket, where the code generated by Nuxt `generate` command will be deployed.
- a CloudFront distribution to handle on-the-edge caching.

The S3 bucket will contain all the HTML generated so, in this case, is a file will not be found the bucket will return the `404.html` file and a 404 status code. The CloudFront deployment simply returns the error with modifications.

## Deploy

To deploy the new version of the code push changes to `develop` (for staging environment) or `master` (for production environment). The GitHub actions will perform the following operations:
- install npm dependencies
- run Nuxt `generate` command (that also build the application)
- upload the code from `./dist` folder to the specified bucket
- create a CloudFront invalidation

It is recommended to use GitFlow to manage the repository.

## Automatic Publish

The webhook application (describe in `template.webhook.yml`) expose an API endpoint that Storyblok can call as webhook in order to trigger `production` workflow (the GitHub action).
